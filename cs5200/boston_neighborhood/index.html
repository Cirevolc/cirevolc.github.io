<!DOCTYPE html>
<meta charset="utf-8">

<style>
    .bar {
        fill: orange;
    }

    path {

        stroke: #fff;
        stroke-width: .5;
        stroke-dasharray: 1;
        fill: #afafaf;

    }

    #neighborhoodPopover {
        position: absolute;
        text-align: center;
        padding: 2px;
        font: 16px sans-serif;
        background: #fff;
        border: 0px;
        border-radius: 8px;
        pointer-events: none;
        opacity: 0;
    }
</style>

<body>
    <svg width="960" height="720" id="svg1"></svg>
    <svg width="480" height="720" id="svg2"></svg>
    <svg width="480" height="720" id="svg3"></svg>
    <div id='neighborhoodPopover'> </div>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://d3js.org/topojson.v1.min.js"></script>
    <script>

        var crimeData;

        d3.csv("crimeRate_by_zipcode_across_UCR.csv", function (data) {
            crimeData = data;
            crimeData.forEach(function (row) {
                row.crime_rate = +row.crime_rate;
            });
        });

        var color = d3.scaleLinear()
            .domain([0, 1])
            .clamp(true)
            .range(['#d0f5f5', '#1d5959']);

        function crimeRate(d) {
            var zipcode = d.properties.ZIP5;
            var crime_rate = 0;
            crimeData.forEach(function (row) {
                if (row.zipcode == zipcode && row.year == "2017") {
                    crime_rate = crime_rate + row.crime_rate;
                }
            });
            return crime_rate.toFixed(4);
        }

        function fillFn(d) {
            return color(crimeRate(d));
        }


        function drawCharts2(zip_code) {
            // set the dimensions and margins of the graph
            var margin = { top: 20, right: 20, bottom: 30, left: 40 },
                width = 640 - margin.left - margin.right,
                height = 200 - margin.top - margin.bottom;

            // set the ranges
            var x = d3.scaleBand()
                .range([0, width])
                .padding(0.1);
            var y = d3.scaleLinear()
                .range([height, 0]);

            // append the svg object to the body of the page
            // append a 'group' element to 'svg'
            // moves the 'group' element to the top left margin
            var svg = d3.select("#svg2")
                .append("g")
                .attr("transform",
                    "translate(" + margin.left + "," + margin.top + ")");

            // get the data
            d3.csv("crimeRate_by_zipcode_across_UCR.csv", function (error, data) {
                if (error) throw error;

                // format the data
                data.forEach(function (d) {
                    d.crime_rate = +d.crime_rate;
                });

                data = data.filter(function (d) { return d.zipcode == zip_code && d.year == "2017"; });

                // Scale the range of the data in the domains
                x.domain(data.map(function (d) { return d.UCR_PART; }));
                y.domain([0, d3.max(data, function (d) { return d.crime_rate; })]);

                // append the rectangles for the bar chart
                svg.selectAll(".bar")
                    .data(data)
                    .enter().append("rect")
                    .attr("class", "bar")
                    .attr("x", function (d) { return x(d.UCR_PART); })
                    .attr("width", x.bandwidth())
                    .attr("y", function (d) { return y(d.crime_rate); })
                    .attr("height", function (d) { return height - y(d.crime_rate); });

                // add the x Axis
                svg.append("g")
                    .attr("transform", "translate(0," + height + ")")
                    .call(d3.axisBottom(x));

                // add the y Axis
                svg.append("g")
                    .call(d3.axisLeft(y));

            });
        }

        function destroyCharts2() {
            var svg = d3.select("#svg2");
            svg.selectAll("*").remove();
        }

        function drawCharts3(zip_code) {
            // set the dimensions and margins of the graph
            var margin = { top: 20, right: 20, bottom: 30, left: 40 },
                width = 640 - margin.left - margin.right,
                height = 200 - margin.top - margin.bottom;

            // set the ranges
            var x = d3.scaleBand()
                .range([0, width])
                .padding(0.1);
            var y = d3.scaleLinear()
                .range([height, 0]);

            // append the svg object to the body of the page
            // append a 'group' element to 'svg'
            // moves the 'group' element to the top left margin
            var svg = d3.select("#svg3")
                .append("g")
                .attr("transform",
                    "translate(" + margin.left + "," + margin.top + ")");

            // get the data
            d3.csv("crimeRate_by_zipcode_across_months.csv", function (error, data) {
                if (error) throw error;

                // format the data
                data.forEach(function (d) {
                    d.crime_rate = +d.crime_rate;
                });

                data = data.filter(function (d) { return d.zipcode == zip_code && d.year == "2017"; });

                // Scale the range of the data in the domains
                x.domain(data.map(function (d) { return d.month; }));
                y.domain([0, d3.max(data, function (d) { return d.crime_rate; })]);

                // append the rectangles for the bar chart
                svg.selectAll(".bar")
                    .data(data)
                    .enter().append("rect")
                    .attr("class", "bar")
                    .attr("x", function (d) { return x(d.month); })
                    .attr("width", x.bandwidth())
                    .attr("y", function (d) { return y(d.crime_rate); })
                    .attr("height", function (d) { return height - y(d.crime_rate); });

                // add the x Axis
                svg.append("g")
                    .attr("transform", "translate(0," + height + ")")
                    .call(d3.axisBottom(x));

                // add the y Axis
                svg.append("g")
                    .call(d3.axisLeft(y));

            });
        }

        function destroyCharts3() {
            var svg = d3.select("#svg3");
            svg.selectAll("*").remove();
        }

        var svg = d3.select("#svg1"),
            width = +svg.attr("width"),
            height = +svg.attr("height");

        d3.json("ZIP_Codes.geojson", function (error, boston) {
            if (error) throw error;

            var path = d3.geoPath()
                .projection(d3.geoConicConformal()
                    .parallels([41 + 43 / 60, 42 + 41 / 60])
                    .rotate([71 + 30 / 60, 0])
                    .fitSize([width, height], boston));

            svg.selectAll("path")
                .data(boston.features)
                .enter().append("path")
                .attr("d", path)
                .style('fill', fillFn)
                .on("mouseenter", function (d) {
                    console.log(d);
                    d3.select(this)
                        .style("stroke-width", 1.5)
                        .style("stroke-dasharray", 0)
                        .style("fill", "orange");

                    d3.select("#neighborhoodPopover")
                        .transition()
                        .style("opacity", 1)
                        .style("left", (d3.event.pageX) + "px")
                        .style("top", (d3.event.pageY) + "px")
                        .text("Zip code: " + d.properties.ZIP5 + "  " + "Crime rate: " + crimeRate(d));

                    // Function to draw two charts.
                    drawCharts2(d.properties.ZIP5);
                    drawCharts3(d.properties.ZIP5);
                })
                .on("mouseleave", function (d) {
                    d3.select(this)
                        .style("stroke-width", .25)
                        .style("stroke-dasharray", 1)
                        .style('fill', fillFn);

                    d3.select("#neighborhoodPopover")
                        .transition()
                        .style("opacity", 0);

                    // Function to remove two charts.
                    destroyCharts2();
                    destroyCharts3();
                });

            console.log(boston);
        });

    </script>
</body>