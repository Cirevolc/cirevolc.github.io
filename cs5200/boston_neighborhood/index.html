<!DOCTYPE html>
<meta charset="utf-8">

<style>
    path {

        stroke: #fff;
        stroke-width: .5;
        stroke-dasharray: 1;
        fill: #afafaf;

    }

    #neighborhoodPopover {
        position: absolute;
        text-align: center;
        padding: 2px;
        font: 12px sans-serif;
        background: #fff;
        border: 0px;
        border-radius: 8px;
        pointer-events: none;
        opacity: 0;
    }
</style>

<body>
    <svg width="960" height="720"></svg>
    <div id='neighborhoodPopover'> </div>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://d3js.org/topojson.v1.min.js"></script>
    <script>

        var crimeData;

        d3.csv("crimeRate_by_zipcode_across_UCR.csv", function(data){
            crimeData = data;
        });

        var color = d3.scaleLinear()
            .domain([0, 1])
            .clamp(true)
            .range(['#d0f5f5', '#1d5959']);

        function crimeRate(d) {
            var zipcode = d.properties.ZIP5;
            var crime_rate = 0;
            crimeData.forEach(function (row) {
                if (row.zipcode == zipcode && row.year == "2018"){
                    row.crime_rate = +row.crime_rate;
                    crime_rate = crime_rate + row.crime_rate;
                }
            });
            return crime_rate;
            // according to d.properties.ZIP5, return corresponding crime rate of year 2018
        }

        function fillFn(d) {
            return color(crimeRate(d));
        }



        var svg = d3.select("svg"),
            width = +svg.attr("width"),
            height = +svg.attr("height");

        d3.json("ZIP_Codes.geojson", function (error, boston) {
            if (error) throw error;

            var path = d3.geoPath()
                .projection(d3.geoConicConformal()
                    .parallels([41 + 43 / 60, 42 + 41 / 60])
                    .rotate([71 + 30 / 60, 0])
                    .fitSize([width, height], boston));

            svg.selectAll("path")
                .data(boston.features)
                .enter().append("path")
                .attr("d", path)
                .style('fill', fillFn)
                .on("mouseenter", function (d) {
                    console.log(d);
                    d3.select(this)
                        .style("stroke-width", 1.5)
                        .style("stroke-dasharray", 0)
                        .style("fill", "orange");

                    d3.select("#neighborhoodPopover")
                        .transition()
                        .style("opacity", 1)
                        .style("left", (d3.event.pageX) + "px")
                        .style("top", (d3.event.pageY) + "px")
                        .text("Zip code: " + d.properties.ZIP5 + "\n" + "Crime rate: " + crimeRate(d));

                })
                .on("mouseleave", function (d) {
                    d3.select(this)
                        .style("stroke-width", .25)
                        .style("stroke-dasharray", 1)
                        .style('fill', fillFn);

                    d3.select("#neighborhoodPopover")
                        .transition()
                        .style("opacity", 0);
                });

            console.log(boston);
        });

    </script>
</body>