<!DOCTYPE html>
<meta charset="utf-8">

<style>
    .bar { fill: orange; }

    path {

        stroke: #fff;
        stroke-width: .5;
        stroke-dasharray: 1;
        fill: #afafaf;

    }

    #neighborhoodPopover {
        position: absolute;
        text-align: center;
        padding: 2px;
        font: 16px sans-serif;
        background: #fff;
        border: 0px;
        border-radius: 8px;
        pointer-events: none;
        opacity: 0;
    }
</style>

<body>
    <svg width="960" height="720" id="svg1"></svg>
    <svg width="660" height="360" id="svg2"></svg>
    <svg width="660" height="360" id="svg3"></svg>
    <div id='neighborhoodPopover'> </div>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://d3js.org/topojson.v1.min.js"></script>
    <script>

        var crimeData;

        d3.csv("crimeRate_by_zipcode_across_UCR.csv", function(data){
            crimeData = data;
            crimeData.forEach(function (row) {
                row.crime_rate = +row.crime_rate;
            });
        });

        var color = d3.scaleLinear()
            .domain([0, 1])
            .clamp(true)
            .range(['#d0f5f5', '#1d5959']);

        function crimeRate(d) {
            var zipcode = d.properties.ZIP5;
            var crime_rate = 0;
            crimeData.forEach(function (row) {
                if (row.zipcode == zipcode && row.year == "2018"){                 
                    crime_rate = crime_rate + row.crime_rate;
                }
            });
            return crime_rate.toFixed(4);
        }

        function fillFn(d) {
            return color(crimeRate(d));
        }


        function drawCharts(d){
            var margin = {top: 50, right: 50, bottom: 50, left: 50},
                width = 660 - margin.left - margin.right,
                height = 360 - margin.top - margin.bottom;
            var x = d3.scaleBand().range([0, width]).padding(0.1);
            var y = d3.scaleLinear().range([height, 0]);
            var data = crimeData.filter(function (row) { return row.zipcode == d.properties.ZIP5 && row.year == "2018"; });
            x.domain(data.map(function(row) { return row.UCR_PART; }));
            y.domain([0, d3.max(data, function(row) { return row.crime_rate; })]);

            var svg2 = d3.select("#svg2");

            svg2.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");

            svg2.selectAll(".bar")
                .data(data)
                .enter().append("rect")
                .attr("class", "bar")
                .attr("x", function(row) { return x(row.UCR_PART); })
                .attr("width", x.bandwidth())
                .attr("y", function(row) { return y(row.crime_rate); })
                .attr("height", function(row) { return height - y(row.crime_rate); });
            
            svg2.append("g").attr("transform", "translate(0," + height + ")").call(d3.axisBottom(x));
            svg2.append("g").call(d3.axisLeft(y));
        }

        function destroyCharts(){
            var svg2 = d3.select("#svg2");
            svg2.selectAll("*").remove();
        }

        var svg = d3.select("#svg1"),
            width = +svg.attr("width"),
            height = +svg.attr("height");

        d3.json("ZIP_Codes.geojson", function (error, boston) {
            if (error) throw error;

            var path = d3.geoPath()
                .projection(d3.geoConicConformal()
                    .parallels([41 + 43 / 60, 42 + 41 / 60])
                    .rotate([71 + 30 / 60, 0])
                    .fitSize([width, height], boston));

            svg.selectAll("path")
                .data(boston.features)
                .enter().append("path")
                .attr("d", path)
                .style('fill', fillFn)
                .on("mouseenter", function (d) {
                    console.log(d);
                    d3.select(this)
                        .style("stroke-width", 1.5)
                        .style("stroke-dasharray", 0)
                        .style("fill", "orange");

                    d3.select("#neighborhoodPopover")
                        .transition()
                        .style("opacity", 1)
                        .style("left", (d3.event.pageX) + "px")
                        .style("top", (d3.event.pageY) + "px")
                        .text("Zip code: " + d.properties.ZIP5 + "  " + "Crime rate: " + crimeRate(d));

                    // Function to draw two charts.
                    drawCharts(d);
                })
                .on("mouseleave", function (d) {
                    d3.select(this)
                        .style("stroke-width", .25)
                        .style("stroke-dasharray", 1)
                        .style('fill', fillFn);

                    d3.select("#neighborhoodPopover")
                        .transition()
                        .style("opacity", 0);

                    // Function to remove two charts.
                    destroyCharts();
                });

            console.log(boston);
        });

    </script>
</body>