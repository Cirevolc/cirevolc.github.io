<!DOCTYPE html>
<meta charset="utf-8">
<html lang="en">

<head>
    <title>A Visualization Demo of Crime Data in Boston</title>
    <link rel="stylesheet" href="crime_rate_by_neighborhood_scatter.css" charset="utf-8">
    <script src="https://d3js.org/d3.v4.min.js" charset="utf-8"></script>
    <script src="d3-tip.js"></script>
    <script src="https://d3js.org/topojson.v1.min.js"></script>
    <style>
        .pg-h1 {
            font: 30px "Hiragino Sans GB", "STHeiti", "Microsoft YaHei", SimHei, "Helvetica Neue", Helvetica, Arial, sans-serif !important;
        }

        .pg-h2 {
            font: 20px "Hiragino Sans GB", "STHeiti", "Microsoft YaHei", SimHei, "Helvetica Neue", Helvetica, Arial, sans-serif !important;
        }

        .dd {

            font: 20px "Hiragino Sans GB", "STHeiti", "Microsoft YaHei", SimHei, "Helvetica Neue", Helvetica, Arial, sans-serif !important;
            width: 300px;
            height: 30px;
        }

        #crime_rate_by_neighborhood_scatter {
            font: 16px "Hiragino Sans GB", "STHeiti", "Microsoft YaHei", SimHei, "Helvetica Neue", Helvetica, Arial, sans-serif !important;
        }

        #my_dataviz {
            font: 16px "Hiragino Sans GB", "STHeiti", "Microsoft YaHei", SimHei, "Helvetica Neue", Helvetica, Arial, sans-serif !important;
        }

        #crime_rate_by_neighborhood_and_type_scatter {
            font: 16px "Hiragino Sans GB", "STHeiti", "Microsoft YaHei", SimHei, "Helvetica Neue", Helvetica, Arial, sans-serif !important;
        }

        .bar {
            fill: orange;
        }

        path {

            stroke: #fff;
            stroke-width: .5;
            stroke-dasharray: 1;
            fill: #afafaf;

        }

        #neighborhoodPopover {
            position: absolute;
            text-align: center;
            padding: 2px;
            font: 16px "Hiragino Sans GB", "STHeiti", "Microsoft YaHei", SimHei, "Helvetica Neue", Helvetica, Arial, sans-serif !important;
            background: #fff;
            border: 0px;
            border-radius: 8px;
            pointer-events: none;
            opacity: 0;
        }

        #svg2 {
            font: 12px "Hiragino Sans GB", "STHeiti", "Microsoft YaHei", SimHei, "Helvetica Neue", Helvetica, Arial, sans-serif !important;
        }

        #svg3 {
            font: 12px "Hiragino Sans GB", "STHeiti", "Microsoft YaHei", SimHei, "Helvetica Neue", Helvetica, Arial, sans-serif !important;
        }

    </style>
</head>

<body>
    <h1 align="center" class="pg-h1">
        Over the last 4 years, the average crime rate across Boston area is 0.072.
    </h1>
    <h2 align="center" class="pg-h2">
        Select a neighborhood in Boston:
    </h2>
    <div align="center"><select class="dd" id="neighborhood_select" onchange="dropDownCallBack()">
            <option value="Allston">Allston</option>
            <option value="Boston">Boston</option>
            <option value="Brighton">Brighton</option>
            <option value="Brookline">Brookline</option>
            <option value="Cambridge">Cambridge</option>
            <option value="Charlestown">Charlestown</option>
            <option value="Chelsea">Chelsea</option>
            <option value="Dedham">Dedham</option>
            <option value="Dorchester">Dorchester</option>
            <option value="Dorchester Center">Dorchester Center</option>
            <option value="Hyde Park">Hyde Park</option>
            <option value="Jamaica Plain">Jamaica Plain</option>
            <option value="Mattapan">Mattapan</option>
            <option value="Milton">Milton</option>
            <option value="Quincy">Quincy</option>
            <option value="Revere">Revere</option>
            <option value="Roslindale">Roslindale</option>
            <option value="Roxbury">Roxbury</option>
            <option value="Roxbury Crossing">Roxbury Crossing</option>
            <option value="Somerville">Somerville</option>
            <option value="West Roxbury">West Roxbury</option>
            <option value="Winthrop">Winthrop</option>
        </select></div>
    <h2 align="center" class="pg-h2" id="drop_down_display1">
        Crime rate:
    </h2>
    <h2 align="center" class="pg-h2" id="drop_down_display2">
        Average price of property:
    </h2>
    <div align="center" id="crime_rate_by_neighborhood_scatter"></div>
    <div align="center"><svg id="my_dataviz" height=42 width=800></svg></div>
    <div align="center" id="crime_rate_by_neighborhood_and_type_scatter"></div>

    <div align="center"><svg width="620" height="480" id="svg1"></svg>
        <svg width="300" height="400" id="svg2"></svg>
        <svg width="300" height="400" id="svg3"></svg>
        <div id='neighborhoodPopover'> </div></div>
    



    <script>
        function dropDownCallBack() {
            d3.csv("crime_rate_by_neighborhood.csv", function (data) {
                data.forEach(function (d) {
                    if (d.Neighborhood == document.getElementById("neighborhood_select").value) {
                        document.getElementById("drop_down_display1").innerHTML = "Crime rate: " + Number(d["Crime Rate By Neighborhood"]).toFixed(4);
                    }
                });
            });
            d3.csv("average_price_by_neighborhood.csv", function (data) {
                data.forEach(function (d) {
                    if (d.area == document.getElementById("neighborhood_select").value) {
                        document.getElementById("drop_down_display2").innerHTML = "Average price of property: $" + Number(d["average_price_per_square_feet"]).toFixed(2) + "/sf";
                    }
                });
            });
        }
    </script>
    <script>
        var margin = { top: 50, right: 300, bottom: 50, left: 50 },
            outerWidth = 1050,
            outerHeight = 500,
            width = outerWidth - margin.left - margin.right,
            height = outerHeight - margin.top - margin.bottom;

        var x = d3.scaleLinear()
            .range([0, width]).nice();

        var y = d3.scaleLinear()
            .range([height, 0]).nice();

        var xCat = "Neighborhood",
            yCat = "Crime Rate By Neighborhood",
            rCat = 5,
            colorCat = "Neighborhood";

        var xCat_type = "UCR part1 rate",
            xCat2_type = "UCR part3 rate",
            yCat_type = "Avg. Crime Rate By Neighborhood",
            rCat_type = 5,
            colorCat_type = "Neighborhood";
    </script>
    <script src="crime_rate_by_neighborhood_scatter.js" charset="utf-8"></script>
    <script src="crime_rate_by_neighborhood_and_type_scatter.js" charset="utf-8"></script>

    <script>

        var crimeData;

        d3.csv("crimeRate_by_zipcode_across_UCR.csv", function (data) {
            crimeData = data;
            crimeData.forEach(function (row) {
                row.crime_rate = +row.crime_rate;
            });
        });

        var color = d3.scaleLinear()
            .domain([0, 1])
            .clamp(true)
            .range(['#d0f5f5', '#1d5959']);

        function crimeRate(d) {
            var zipcode = d.properties.ZIP5;
            var crime_rate = 0;
            crimeData.forEach(function (row) {
                if (row.zipcode == zipcode && row.year == "2017") {
                    crime_rate = crime_rate + row.crime_rate;
                }
            });
            return crime_rate.toFixed(4);
        }

        function fillFn(d) {
            return color(crimeRate(d));
        }


        function drawCharts2(zip_code) {
            // set the dimensions and margins of the graph
            var margin = { top: 60, right: 20, bottom: 30, left: 40 },
                width = 300 - margin.left - margin.right,
                height = 400 - margin.top - margin.bottom;

            // set the ranges
            var x = d3.scaleBand()
                .range([0, width])
                .padding(0.1);
            var y = d3.scaleLinear()
                .range([height, 0]);

            // append the svg object to the body of the page
            // append a 'group' element to 'svg'
            // moves the 'group' element to the top left margin
            var svg = d3.select("#svg2")
                .append("g")
                .attr("transform",
                    "translate(" + margin.left + "," + margin.top + ")");

            // get the data
            d3.csv("crimeRate_by_zipcode_across_UCR.csv", function (error, data) {
                if (error) throw error;

                // format the data
                data.forEach(function (d) {
                    d.crime_rate = +d.crime_rate;
                });

                data = data.filter(function (d) { return d.zipcode == zip_code && d.year == "2017"; });

                // Scale the range of the data in the domains
                x.domain(data.map(function (d) { return d.UCR_PART; }));
                y.domain([0, d3.max(data, function (d) { return d.crime_rate; })]);

                // append the rectangles for the bar chart
                svg.selectAll(".bar")
                    .data(data)
                    .enter().append("rect")
                    .attr("class", "bar")
                    .attr("x", function (d) { return x(d.UCR_PART); })
                    .attr("width", x.bandwidth())
                    .attr("y", function (d) { return y(d.crime_rate); })
                    .attr("height", function (d) { return height - y(d.crime_rate); });

                // add the x Axis
                svg.append("g")
                    .attr("transform", "translate(0," + height + ")")
                    .call(d3.axisBottom(x));

                // add the y Axis
                svg.append("g")
                    .call(d3.axisLeft(y));

                svg.append("text")
                    .attr("x", 50)
                    .attr("y", 0)
                    .style("font-size", "14px")
                    .text("Crime Rate By Type");

            });
        }

        function destroyCharts2() {
            var svg = d3.select("#svg2");
            svg.selectAll("*").remove();
        }

        function drawCharts3(zip_code) {
            // set the dimensions and margins of the graph
            var margin = { top: 60, right: 20, bottom: 30, left: 40 },
                width = 300 - margin.left - margin.right,
                height = 400 - margin.top - margin.bottom;

            // set the ranges
            var x = d3.scaleBand()
                .range([0, width])
                .padding(0.1);
            var y = d3.scaleLinear()
                .range([height, 0]);

            // append the svg object to the body of the page
            // append a 'group' element to 'svg'
            // moves the 'group' element to the top left margin
            var svg = d3.select("#svg3")
                .append("g")
                .attr("transform",
                    "translate(" + margin.left + "," + margin.top + ")");

            // get the data
            d3.csv("crimeRate_by_zipcode_across_months.csv", function (error, data) {
                if (error) throw error;

                // format the data
                data.forEach(function (d) {
                    d.crime_rate = +d.crime_rate;
                });

                data = data.filter(function (d) { return d.zipcode == zip_code && d.year == "2017"; });

                // Scale the range of the data in the domains
                x.domain(data.map(function (d) { return d.month; }));
                y.domain([0, d3.max(data, function (d) { return d.crime_rate; })]);

                // append the rectangles for the bar chart
                svg.selectAll(".bar")
                    .data(data)
                    .enter().append("rect")
                    .attr("class", "bar")
                    .attr("x", function (d) { return x(d.month); })
                    .attr("width", x.bandwidth())
                    .attr("y", function (d) { return y(d.crime_rate); })
                    .attr("height", function (d) { return height - y(d.crime_rate); });

                // add the x Axis
                svg.append("g")
                    .attr("transform", "translate(0," + height + ")")
                    .call(d3.axisBottom(x));

                // add the y Axis
                svg.append("g")
                    .call(d3.axisLeft(y));

                svg.append("text")
                    .attr("x", 50)
                    .attr("y", 0)
                    .style("font-size", "14px")
                    .text("Crime Rate By Month");

            });
        }

        function destroyCharts3() {
            var svg = d3.select("#svg3");
            svg.selectAll("*").remove();
        }

        var svg = d3.select("#svg1"),
            width = +svg.attr("width"),
            height = +svg.attr("height");

        d3.json("ZIP_Codes.geojson", function (error, boston) {
            if (error) throw error;

            var path = d3.geoPath()
                .projection(d3.geoConicConformal()
                    .parallels([41 + 43 / 60, 42 + 41 / 60])
                    .rotate([71 + 30 / 60, 0])
                    .fitSize([width, height], boston));

            svg.selectAll("path")
                .data(boston.features)
                .enter().append("path")
                .attr("d", path)
                .style('fill', fillFn)
                .on("mouseenter", function (d) {
                    console.log(d);
                    d3.select(this)
                        .style("stroke-width", 1.5)
                        .style("stroke-dasharray", 0)
                        .style("fill", "orange");

                    d3.select("#neighborhoodPopover")
                        .transition()
                        .style("opacity", 1)
                        .style("left", (d3.event.pageX) + "px")
                        .style("top", (d3.event.pageY) + "px")
                        .text("Zip code: " + d.properties.ZIP5 + "  " + "Crime rate: " + crimeRate(d));

                    // Function to draw two charts.
                    drawCharts2(d.properties.ZIP5);
                    drawCharts3(d.properties.ZIP5);
                })
                .on("mouseleave", function (d) {
                    d3.select(this)
                        .style("stroke-width", .25)
                        .style("stroke-dasharray", 1)
                        .style('fill', fillFn);

                    d3.select("#neighborhoodPopover")
                        .transition()
                        .style("opacity", 0);

                    // Function to remove two charts.
                    destroyCharts2();
                    destroyCharts3();
                });
        });

    </script>
</body>

</html>